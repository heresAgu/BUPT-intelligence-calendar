<!-- pages/ocr-course/ocr-course.wxml -->
<view class="ocr-page">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <view class="nav-back" bindtap="goBack">è¿”å›</view>
    <text class="title">æ‹ç…§è¯†åˆ«è¯¾ç¨‹è¡¨</text>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <scroll-view class="content" scroll-y>
    
    <!-- å¼•å¯¼åŒºåŸŸ -->
    <view class="guide-section" wx:if="{{status === 'idle' || status === 'selecting'}}">
      <view class="guide-title">æ‹ç…§è¯†åˆ«è¯¾ç¨‹è¡¨</view>
      <view class="guide-subtitle">å¿«é€Ÿå¯¼å…¥è¯¾ç¨‹ï¼Œå‘Šåˆ«æ‰‹åŠ¨è¾“å…¥</view>
      
      <view class="guide-tips">
        <view class="tip-item">
          
          <text class="tip-text">æ‹æ‘„æ¸…æ™°çš„è¯¾ç¨‹è¡¨ç…§ç‰‡</text>
        </view>
        <view class="tip-item">
          
          <text class="tip-text">ç¡®ä¿å…‰çº¿å……è¶³ï¼Œæ–‡å­—æ¸…æ™°</text>
        </view>
        <view class="tip-item">
          
          <text class="tip-text">å°½é‡æ­£å¯¹æ‹æ‘„ï¼Œé¿å…å€¾æ–œ</text>
        </view>
      </view>
      
      <button class="btn-scan" bindtap="chooseImage">
        
        <text>æ‹æ‘„/é€‰æ‹©è¯¾ç¨‹è¡¨ç…§ç‰‡</text>
      </button>
    </view>

    <!-- å¤„ç†çŠ¶æ€ -->
    <view class="status-section" wx:if="{{status !== 'idle' && status !== 'preview' && status !== 'success'}}">
      <view class="status-card">
        <view class="status-icon">{{status === 'uploading' ? 'ğŸ“¤' : status === 'recognizing' ? 'ğŸ”' : 'â³'}}</view>
        <text class="status-title">{{getStatusText(status)}}</text>
        
        <!-- å›¾ç‰‡é¢„è§ˆ -->
        <image 
          wx:if="{{imagePath && status !== 'selecting'}}" 
          src="{{imagePath}}" 
          mode="widthFix" 
          class="preview-image"
        ></image>
        
        <!-- è¿›åº¦æ¡ -->
        <view class="progress" wx:if="{{status === 'uploading' || status === 'recognizing'}}">
          <view class="progress-bar"></view>
        </view>
      </view>
    </view>

    <!-- é¢„è§ˆç»“æœ -->
    <view class="preview-section" wx:if="{{status === 'preview' || status === 'success'}}">
      <view class="preview-header">
        
        <view class="preview-actions">
          <text class="action-btn" bindtap="toggleSelectAll">
            {{isAllSelected ? 'å…¨ä¸é€‰' : 'å…¨é€‰'}}
          </text>
          <text class="action-btn" bindtap="retry">é‡æ–°è¯†åˆ«</text>
        </view>
      </view>
      
      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="stats-info">
        <view class="stat-item">
          <text class="stat-label">è¯†åˆ«åˆ°</text>
          <text class="stat-value">{{stats.total}}ä¸ª</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">é€‰ä¸­</text>
          <text class="stat-value">{{stats.selected}}ä¸ª</text>
        </view>
        <view class="stat-item" wx:if="{{status === 'success'}}">
          <text class="stat-label">å¯¼å…¥</text>
          <text class="stat-value success">{{stats.imported}}ä¸ª</text>
        </view>
        <view class="stat-item" wx:if="{{status === 'success'}}">
          <text class="stat-label">å·²å­˜åœ¨</text>
          <text class="stat-value duplicate">{{stats.duplicate}}ä¸ª</text>
        </view>
      </view>
      
      <!-- è¯¾ç¨‹åˆ—è¡¨ -->
      <view class="courses-list">
        <view 
          class="course-item {{selectedRows[index] ? 'selected' : ''}} {{item.isImported === 'success' ? 'imported' : ''}} {{item.isImported === 'duplicate' ? 'duplicate' : ''}}"
          wx:for="{{parsedCourses}}"
          wx:key="id"
          data-index="{{index}}"
          bindtap="toggleSelect"
        >
          <!-- é€‰æ‹©æ¡† -->
          <view class="select-checkbox">
            <view class="checkbox {{selectedRows[index] ? 'checked' : ''}}">
              {{selectedRows[index] ? 'âœ“' : ''}}
            </view>
          </view>
          
          <!-- è¯¾ç¨‹ä¿¡æ¯ -->
          <view class="course-info">
            <!-- é¢œè‰²æ ‡ç­¾ -->
            <view class="color-tag" style="background-color: {{item.color}}"></view>
            
            <view class="course-main">
              <view class="course-name">{{item.name}}</view>
              <view class="course-details">
                <text class="detail-item" wx:if="{{item.teacher}}">
                  
                  {{item.teacher}}
                </text>
                <text class="detail-item" wx:if="{{item.time}}">
                  
                  {{item.time}}
                </text>
                <text class="detail-item" wx:if="{{item.classroom}}">
                  
                  {{item.classroom}}
                </text>
              </view>
            </view>
          </view>
          
          <!-- çŠ¶æ€æ ‡ç­¾ -->
          <view class="status-tag" wx:if="{{item.isImported}}">
            {{item.isImported === 'success' ? 'å·²å¯¼å…¥' : 'å·²å­˜åœ¨'}}
          </view>
        </view>
      </view>
      
      <!-- å¯¼å…¥æç¤º -->
      <view class="import-tip" wx:if="{{status === 'preview'}}">
        
        <text class="tip-text">å·²è‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨çš„è¯¾ç¨‹ï¼Œå¯ä»¥å–æ¶ˆé€‰æ‹©ä¸éœ€è¦çš„è¯¾ç¨‹</text>
      </view>
      
      <!-- æˆåŠŸæç¤º -->
      <view class="success-tip" wx:if="{{status === 'success'}}">
        
        <text class="tip-text">è¯¾ç¨‹å¯¼å…¥æˆåŠŸï¼{{stats.imported}}ä¸ªæ–°è¯¾ç¨‹å·²æ·»åŠ </text>
      </view>
    </view>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <view class="error-section" wx:if="{{status === 'error'}}">
      <view class="error-card">
        <view class="error-icon">âŒ</view>
        <text class="error-title">è¯†åˆ«å¤±è´¥</text>
        <text class="error-desc">{{errorMessage || 'è¯·é‡è¯•'}}</text>
        
        <button class="btn-retry" bindtap="retry">é‡æ–°å°è¯•</button>
        
        <view class="error-tips">
          <text class="tip-title">è¯†åˆ«å°æŠ€å·§ï¼š</text>
          <text class="tip-item">1. ç¡®ä¿ç…§ç‰‡å…‰çº¿å……è¶³</text>
          <text class="tip-item">2. å°½é‡æ­£å¯¹è¯¾ç¨‹è¡¨æ‹æ‘„</text>
          <text class="tip-item">3. é¿å…ç…§ç‰‡æ¨¡ç³Šæˆ–åå…‰</text>
        </view>
      </view>
    </view>
    
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <view class="action-buttons" wx:if="{{status === 'preview'}}">
    <button class="btn-cancel" bindtap="retry">å–æ¶ˆ</button>
    <button 
      class="btn-import" 
      bindtap="confirmImport"
      disabled="{{stats.selected === 0}}"
    >
      å¯¼å…¥é€‰ä¸­çš„è¯¾ç¨‹
    </button>
  </view>
</view>